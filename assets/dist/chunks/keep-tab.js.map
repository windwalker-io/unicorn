{"version":3,"file":"keep-tab.js","sources":["../../src/bootstrap/keep-tab.ts"],"sourcesContent":["import { useUniDirective } from '../composable';\r\nimport { module, selectAll, selectOne, sleep } from '../service';\r\nimport { Tab } from 'bootstrap';\r\nimport { mergeDeep } from '../utilities';\r\n\r\nexport interface KeepTabOptions {\r\n  uid?: string;\r\n  delay?: number;\r\n  tabItemSelector?: string;\r\n}\r\n\r\nconst defaultOptions = {\r\n  tabItemSelector: '[data-toggle=tab],[data-bs-toggle=tab],[data-toggle=pill],[data-bs-toggle=pill]',\r\n  delay: 0,\r\n};\r\n\r\nexport class KeepTab {\r\n  $element: HTMLElement;\r\n  tabButtons!: NodeListOf<HTMLElement>;\r\n  storageKey: string = '';\r\n  options: any;\r\n\r\n  constructor(selector: HTMLElement | string, options: KeepTabOptions = {}) {\r\n    options = mergeDeep({}, defaultOptions, options);\r\n    let uid: string;\r\n\r\n    if (typeof selector === 'object') {\r\n      uid = options.uid || selector.id;\r\n    } else {\r\n      uid = selector;\r\n    }\r\n\r\n    const $element = this.$element = selectOne<HTMLElement>(selector)!;\r\n\r\n    if (!$element) {\r\n      console.warn(`[KeepTab] Element ${selector} not found.`);\r\n      return;\r\n    }\r\n\r\n    this.options = options;\r\n\r\n    this.$element = $element;\r\n    this.tabButtons = $element.querySelectorAll(this.options.tabItemSelector);\r\n\r\n    this.init(uid);\r\n  }\r\n\r\n  protected async init(uid: string) {\r\n    this.storageKey = 'tab-href-' + await this.hashCode(location.href + ':' + uid);\r\n\r\n    this.bindEvents();\r\n\r\n    await sleep(this.options.delay || 0);\r\n\r\n    this.switchTab();\r\n  }\r\n\r\n  bindEvents() {\r\n    [].forEach.call(this.tabButtons, (button: HTMLAnchorElement) => {\r\n      button.addEventListener('click', () => {\r\n        // Store the selected tab href in localstorage\r\n        window.localStorage.setItem(this.storageKey, this.getButtonHref(button));\r\n      });\r\n    });\r\n  }\r\n\r\n  getButtonHref(button: HTMLAnchorElement) {\r\n    return button.dataset.bsTarget || button.dataset.target || button.href;\r\n  }\r\n\r\n  findTabButtonByHref(href: string) {\r\n    return selectAll<HTMLAnchorElement>(this.options.tabItemSelector)\r\n      .filter((button: HTMLAnchorElement) => {\r\n        if (button.href === href) {\r\n          return true;\r\n        }\r\n\r\n        if (button.dataset.bsTarget === href) {\r\n          return true;\r\n        }\r\n\r\n        return button.dataset.target === href;\r\n      })\r\n      .shift();\r\n  }\r\n\r\n  activateTab(href: string) {\r\n    const tabTrigger = this.findTabButtonByHref(href);\r\n\r\n    if (tabTrigger) {\r\n      Tab.getOrCreateInstance(tabTrigger).show();\r\n    }\r\n  }\r\n\r\n  hasTab(href: string) {\r\n    return this.findTabButtonByHref(href) != null;\r\n  }\r\n\r\n  /**\r\n   * Switch tab.\r\n   *\r\n   * @returns {boolean}\r\n   */\r\n  switchTab() {\r\n    if (localStorage.getItem(this.storageKey)) {\r\n      // When moving from tab area to a different view\r\n      if (!this.hasTab(localStorage.getItem(this.storageKey) || '')) {\r\n        localStorage.removeItem(this.storageKey);\r\n        return true;\r\n      }\r\n\r\n      // Clean default tabs\r\n      // selectOne(this.$element, '[data-toggle=\"tab\"], [data-bs-toggle=tab]')\r\n      // this.$element.querySelector('a[data-toggle=\"tab\"]').parent().removeClass('active');\r\n\r\n      const tabhref = localStorage.getItem(this.storageKey) || '';\r\n\r\n      // Add active attribute for selected tab indicated by url\r\n      this.activateTab(tabhref);\r\n\r\n      // Check whether internal tab is selected (in format <tabname>-<id>)\r\n      // const seperatorIndex = tabhref.indexOf('-');\r\n      //\r\n      // if (seperatorIndex !== -1) {\r\n      //   const singular = tabhref.substring(0, seperatorIndex);\r\n      //   const plural = singular + 's';\r\n      //\r\n      //   this.activateTab(plural);\r\n      // }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Hash code.\r\n   */\r\n  async hashCode(text: string): Promise<string> {\r\n    const msgBuffer = new TextEncoder().encode(text);\r\n    const hashBuffer = await globalThis.crypto.subtle.digest(\"SHA-256\", msgBuffer);\r\n    const hashArray = Array.from(new Uint8Array(hashBuffer));\r\n    return hashArray.map(b => b.toString(16).padStart(2, \"0\")).join(\"\");\r\n  }\r\n}\r\n\r\nexport const ready = useUniDirective('keeptab', {\r\n  mounted(el, { value }) {\r\n    const options: KeepTabOptions = JSON.parse(value || '{}');\r\n\r\n    module(el, 'uni.keeptab', () => new KeepTab(el, options));\r\n  }\r\n});\r\n\r\nexport interface KeepTabModule {\r\n  KeepTab: typeof KeepTab;\r\n  ready: typeof ready;\r\n}\r\n"],"names":[],"mappings":";;AAWA,MAAM,iBAAiB;AAAA,EACrB,iBAAiB;AAAA,EACjB,OAAO;AACT;AAEO,MAAM,QAAQ;AAAA,EACnB;AAAA,EACA;AAAA,EACA,aAAqB;AAAA,EACrB;AAAA,EAEA,YAAY,UAAgC,UAA0B,IAAI;AACxE,cAAU,UAAU,IAAI,gBAAgB,OAAO;AAC/C,QAAI;AAEJ,QAAI,OAAO,aAAa,UAAU;AAChC,YAAM,QAAQ,OAAO,SAAS;AAAA,IAChC,OAAO;AACL,YAAM;AAAA,IACR;AAEA,UAAM,WAAW,KAAK,WAAW,UAAuB,QAAQ;AAEhE,QAAI,CAAC,UAAU;AACb,cAAQ,KAAK,qBAAqB,QAAQ,aAAa;AACvD;AAAA,IACF;AAEA,SAAK,UAAU;AAEf,SAAK,WAAW;AAChB,SAAK,aAAa,SAAS,iBAAiB,KAAK,QAAQ,eAAe;AAExE,SAAK,KAAK,GAAG;AAAA,EACf;AAAA,EAEA,MAAgB,KAAK,KAAa;AAChC,SAAK,aAAa,cAAc,MAAM,KAAK,SAAS,SAAS,OAAO,MAAM,GAAG;AAE7E,SAAK,WAAA;AAEL,UAAM,MAAM,KAAK,QAAQ,SAAS,CAAC;AAEnC,SAAK,UAAA;AAAA,EACP;AAAA,EAEA,aAAa;AACX,KAAA,EAAG,QAAQ,KAAK,KAAK,YAAY,CAAC,WAA8B;AAC9D,aAAO,iBAAiB,SAAS,MAAM;AAErC,eAAO,aAAa,QAAQ,KAAK,YAAY,KAAK,cAAc,MAAM,CAAC;AAAA,MACzE,CAAC;AAAA,IACH,CAAC;AAAA,EACH;AAAA,EAEA,cAAc,QAA2B;AACvC,WAAO,OAAO,QAAQ,YAAY,OAAO,QAAQ,UAAU,OAAO;AAAA,EACpE;AAAA,EAEA,oBAAoB,MAAc;AAChC,WAAO,UAA6B,KAAK,QAAQ,eAAe,EAC7D,OAAO,CAAC,WAA8B;AACrC,UAAI,OAAO,SAAS,MAAM;AACxB,eAAO;AAAA,MACT;AAEA,UAAI,OAAO,QAAQ,aAAa,MAAM;AACpC,eAAO;AAAA,MACT;AAEA,aAAO,OAAO,QAAQ,WAAW;AAAA,IACnC,CAAC,EACA,MAAA;AAAA,EACL;AAAA,EAEA,YAAY,MAAc;AACxB,UAAM,aAAa,KAAK,oBAAoB,IAAI;AAEhD,QAAI,YAAY;AACd,UAAI,oBAAoB,UAAU,EAAE,KAAA;AAAA,IACtC;AAAA,EACF;AAAA,EAEA,OAAO,MAAc;AACnB,WAAO,KAAK,oBAAoB,IAAI,KAAK;AAAA,EAC3C;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOA,YAAY;AACV,QAAI,aAAa,QAAQ,KAAK,UAAU,GAAG;AAEzC,UAAI,CAAC,KAAK,OAAO,aAAa,QAAQ,KAAK,UAAU,KAAK,EAAE,GAAG;AAC7D,qBAAa,WAAW,KAAK,UAAU;AACvC,eAAO;AAAA,MACT;AAMA,YAAM,UAAU,aAAa,QAAQ,KAAK,UAAU,KAAK;AAGzD,WAAK,YAAY,OAAO;AAAA,IAW1B;AAAA,EACF;AAAA;AAAA;AAAA;AAAA,EAKA,MAAM,SAAS,MAA+B;AAC5C,UAAM,YAAY,IAAI,cAAc,OAAO,IAAI;AAC/C,UAAM,aAAa,MAAM,WAAW,OAAO,OAAO,OAAO,WAAW,SAAS;AAC7E,UAAM,YAAY,MAAM,KAAK,IAAI,WAAW,UAAU,CAAC;AACvD,WAAO,UAAU,IAAI,CAAA,MAAK,EAAE,SAAS,EAAE,EAAE,SAAS,GAAG,GAAG,CAAC,EAAE,KAAK,EAAE;AAAA,EACpE;AACF;AAEO,MAAM,QAAQ,gCAAgB,WAAW;AAAA,EAC9C,QAAQ,IAAI,EAAE,SAAS;AACrB,UAAM,UAA0B,KAAK,MAAM,SAAS,IAAI;AAExD,WAAO,IAAI,eAAe,MAAM,IAAI,QAAQ,IAAI,OAAO,CAAC;AAAA,EAC1D;AACF,CAAC;"}