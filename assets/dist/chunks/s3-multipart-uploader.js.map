{"version":3,"file":"s3-multipart-uploader.js","sources":["../../src/module/s3-multipart-uploader.ts"],"sourcesContent":["import { AxiosProgressEvent, AxiosResponseHeaders } from 'axios';\r\nimport { Mixin } from 'ts-mixer';\r\nimport { createQueue, useHttpClient } from '../composable';\r\nimport { EventHandler, EventMixin } from '../events';\r\nimport type { MaybePromise } from '../types';\r\nimport { mergeDeep } from '../utilities';\r\nimport { ApiReturn } from './http-client';\r\n\r\ndeclare type RoutingOptions = {\r\n  init: string;\r\n  sign: string;\r\n  complete: string;\r\n  abort: string;\r\n} | ((action: RouteActions) => MaybePromise<string>);\r\n\r\ndeclare type RouteActions = 'init' | 'sign' | 'complete' | 'abort';\r\ndeclare type RequestHandler = <T = Record<string, any>>(action: RouteActions, data: Record<string, any>) => Promise<T>;\r\n\r\nexport interface S3MultipartUploaderOptions {\r\n  profile?: string;\r\n  chunkSize: number;\r\n  concurrency: number;\r\n  routes: RoutingOptions;\r\n  requestHandler?: RequestHandler;\r\n  onProgress?: ProgressEventHandler;\r\n  ACL?: string;\r\n  extra?: Record<string, any>;\r\n\r\n  // maxRetries?: number;\r\n  // endpoint: string;\r\n  // subfolder?: string;\r\n}\r\n\r\nconst defaultOptions: Partial<S3MultipartUploaderOptions> = {\r\n  chunkSize: 5 * 1024 * 1024, // 5MB\r\n  concurrency: 2,\r\n};\r\n\r\nexport interface S3MultipartUploaderRequestOptions {\r\n  onProgress?: ProgressEventHandler;\r\n  filename?: string;\r\n  ContentType?: string;\r\n  ContentDisposition?: string;\r\n  ACL?: string;\r\n  extra?: Record<string, any>;\r\n}\r\n\r\nexport class S3MultipartUploader extends Mixin(EventMixin) {\r\n  options: S3MultipartUploaderOptions;\r\n\r\n  constructor(options: Partial<S3MultipartUploaderOptions>) {\r\n    super();\r\n    this.options = mergeDeep({}, defaultOptions, options);\r\n  }\r\n\r\n  async upload(\r\n    file: string | File | Blob,\r\n    path: string,\r\n    options: S3MultipartUploaderRequestOptions = {}\r\n  ): Promise<{ url: string; }> {\r\n    const extra: Record<string, any> = { ...(this.options.extra ?? {}), ...(options.extra ?? {}) };\r\n\r\n    if (typeof file === 'string') {\r\n      file = new Blob([file], { type: options['ContentType'] || 'text/plain' });\r\n    }\r\n\r\n    if (file instanceof Blob && !(file instanceof File)) {\r\n      if (path.endsWith('.{ext}')) {\r\n        throw new Error('If using Blob or file data string, you must provide a valid file extension in the path.');\r\n      }\r\n\r\n      file = new File([file], 'blob', { type: file.type });\r\n    }\r\n\r\n    if (file instanceof File) {\r\n      extra['ContentType'] = options['ContentType'] || file.type;\r\n    }\r\n\r\n    if (options.ACL || this.options.ACL) {\r\n      extra.ACL = options.ACL || this.options.ACL;\r\n    }\r\n\r\n    path = this.replaceExt(path, file);\r\n\r\n    const initData: Record<string, any> = { extra, path, profile: this.options.profile };\r\n\r\n    if (options['filename']) {\r\n      initData['filename'] = options['filename'];\r\n    }\r\n\r\n    this.trigger('start', file, initData);\r\n\r\n    // @Request sign\r\n    const { id } = await this.request<{ id: string; }>(\r\n      'init',\r\n      initData\r\n    );\r\n\r\n    try {\r\n      const chunkSize = this.options.chunkSize;\r\n      const chunks = Math.ceil(file.size / chunkSize);\r\n\r\n      let uploadedBytes = 0;\r\n      let parts: { ETag: string, PartNumber: number }[] = [];\r\n      let currentPart = 1;\r\n      const queue = createQueue(this.options.concurrency);\r\n      const promises = [];\r\n      const partsUploaded: Record<number, number> = {};\r\n\r\n      // Loop from 1 to chunks\r\n      while (currentPart <= chunks) {\r\n        const partNumber = currentPart;\r\n\r\n        // Push to queue\r\n        const p = queue.push(async () => {\r\n          const { blob, etag } = await this.uploadPart(\r\n            file as File,\r\n            {\r\n              id,\r\n              path,\r\n              partNumber,\r\n              chunkSize,\r\n              onUploadProgress: (e) => {\r\n                partsUploaded[partNumber] = e.loaded;\r\n\r\n                const uploaded = Object.values(partsUploaded).reduce((sum, a) => sum + a, 0);\r\n\r\n                this.updateProgress(uploaded, file.size, options);\r\n              }\r\n            }\r\n          );\r\n\r\n          uploadedBytes += blob.size;\r\n\r\n          this.updateProgress(uploadedBytes, file.size, options);\r\n\r\n          parts.push({ ETag: etag, PartNumber: partNumber });\r\n        });\r\n\r\n        promises.push(p);\r\n\r\n        currentPart++;\r\n      }\r\n\r\n      await Promise.all(promises);\r\n\r\n      // @Request sign\r\n      const { url } = await this.request<{ url: string }>(\r\n        'complete',\r\n        {\r\n          id,\r\n          path,\r\n          parts: parts.sort((a, b) => a.PartNumber - b.PartNumber),\r\n          profile: this.options.profile,\r\n        },\r\n      );\r\n\r\n      this.trigger('success', url);\r\n\r\n      return { url };\r\n    } catch (e) {\r\n      await this.abort(id, path);\r\n\r\n      throw e;\r\n    }\r\n  }\r\n\r\n  protected async uploadPart(\r\n    file: File,\r\n    payload: {\r\n      id: string;\r\n      path: string;\r\n      partNumber: number;\r\n      chunkSize: number;\r\n      onUploadProgress: (e: AxiosProgressEvent) => void;\r\n    }\r\n  ) {\r\n    const http = await useHttpClient();\r\n    const { id, path, partNumber, chunkSize, onUploadProgress } = payload;\r\n\r\n    const start = (partNumber - 1) * chunkSize;\r\n    const end = Math.min(partNumber * chunkSize, file.size);\r\n\r\n    const blob = file.slice(start, end);\r\n\r\n    // @Request sign\r\n    const { url } = await this.request<{ url: string; }>(\r\n      'sign',\r\n      {\r\n        id,\r\n        path,\r\n        partNumber,\r\n        profile: this.options.profile,\r\n      }\r\n    );\r\n\r\n    // PUT to S3\r\n    const res = await http.put(\r\n      url,\r\n      blob,\r\n      {\r\n        onUploadProgress,\r\n      }\r\n    );\r\n\r\n    const etag = String((res.headers as AxiosResponseHeaders).get('ETag') || '');\r\n\r\n    return { blob, etag };\r\n  }\r\n\r\n  protected async request<T = Record<string, any>>(action: RouteActions, body: Record<string, any>): Promise<T> {\r\n    if (this.options.requestHandler) {\r\n      return this.options.requestHandler<T>(action, body);\r\n    }\r\n\r\n    const http = await useHttpClient();\r\n\r\n    const res = await http.post<ApiReturn<T>>(await this.resolveRoute(action), body);\r\n\r\n    return res.data.data;\r\n  }\r\n\r\n  async abort(id: string, path: string) {\r\n    await this.request(\r\n      'abort',\r\n      {\r\n        id,\r\n        path,\r\n        profile: this.options.profile,\r\n      }\r\n    );\r\n  }\r\n\r\n  updateProgress(loaded: number, total: number, options: S3MultipartUploaderRequestOptions) {\r\n    const percentage = (loaded / total) * 100;\r\n\r\n    const event: ProgressEvent = { percentage, loaded, total };\r\n\r\n    this.trigger('progress', event);\r\n\r\n    this.options.onProgress?.(event);\r\n\r\n    if (options.onProgress) {\r\n      options.onProgress(event);\r\n    }\r\n  }\r\n\r\n  async resolveRoute(action: RouteActions): Promise<string> {\r\n    if (typeof this.options.routes === 'function') {\r\n      return this.options.routes(action);\r\n    }\r\n\r\n    return this.options.routes[action];\r\n  }\r\n\r\n  setChunkSize(size: number): this {\r\n    this.options.chunkSize = size;\r\n\r\n    return this;\r\n  }\r\n\r\n  setChunkSizeInMiB(size: number): this {\r\n    this.options.chunkSize = size * 1024 * 1024;\r\n\r\n    return this;\r\n  }\r\n\r\n  replaceExt(path: string, file: File | Blob): string {\r\n    if (file instanceof File) {\r\n      const fileExt = file.name.split('.').pop();\r\n\r\n      if (path.endsWith('.{ext}')) {\r\n        return path.replace(/\\.{ext}$/, fileExt ? '.' + fileExt : '');\r\n      }\r\n    }\r\n\r\n    return path;\r\n  }\r\n\r\n  on(\r\n    event: 'start',\r\n    handler: (file: File, data: { path: string; extra: Record<string, any>; [name: string]: any; }) => void\r\n  ): this;\r\n  on(event: 'success', handler: (url: string) => void): this;\r\n  on(event: 'progress', handler: (event: ProgressEvent) => void): this;\r\n  on(event: string | string[], handler: EventHandler): this {\r\n    return super.on(event, handler);\r\n  }\r\n}\r\n\r\ntype ProgressEvent = {\r\n  percentage: number;\r\n  loaded: number;\r\n  total: number;\r\n};\r\ntype ProgressEventHandler = (e: ProgressEvent) => void;\r\n\r\nexport interface S3MultipartUploaderModule {\r\n  S3MultipartUploader: typeof S3MultipartUploader;\r\n}\r\n"],"names":[],"mappings":"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"}