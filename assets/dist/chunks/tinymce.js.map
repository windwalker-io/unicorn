{"version":3,"file":"tinymce.js","sources":["../../src/module/tinymce.ts"],"sourcesContent":["import type { Editor, EditorOptions, TinyMCE } from 'tinymce';\nimport { useHttpClient, useStack } from '../composable';\nimport { useImport } from '../service';\nimport { Dictionary, MaybePromise } from '../types';\nimport { mergeDeep } from '../utilities';\n\nconst instances: Dictionary<TinymceController> = {};\nlet hooks: ((tinymce: TinyMCE) => MaybePromise<any>)[] = [];\n\nlet imported = false;\n\ndeclare type UploadHandlerParams = Parameters<NonNullable<EditorOptions['images_upload_handler']>>;\n\nexport async function get(\n  selector: string,\n  options: Record<string, any> = {}\n): Promise<TinymceController> {\n  const tinymce = await loadTinymce();\n\n  return instances[selector] ??= new TinymceController(tinymce, document.querySelector(selector)!, options);\n}\n\nexport function destroy(selector: string): void {\n  delete instances[selector];\n}\n\nexport function addHook(handler: ((tinymce: TinyMCE) => MaybePromise<any>)) {\n  hooks.push(handler);\n}\n\nexport function clearHooks() {\n  hooks = [];\n}\n\nasync function loadTinymce(): Promise<TinyMCE> {\n  await useImport('@tinymce');\n\n  if (imported) {\n    return tinymce;\n  }\n  imported = true;\n  for (const hook of hooks) {\n    hook(tinymce);\n  }\n  await registerDragPlugin(tinymce);\n  return tinymce;\n}\n\nconst defaultOptions: Record<string, any> = {};\n\nexport class TinymceController {\n  editor?: Editor;\n  options: Record<string, any> = {};\n\n  constructor(protected tinymce: TinyMCE, public element: HTMLElement, options: Record<string, any>) {\n    options.target = element;\n\n    this.options = mergeDeep(\n      {\n        unicorn: {\n          stack_name: 'uploading'\n        }\n      },\n      defaultOptions,\n      this.prepareOptions(options, tinymce.majorVersion),\n    );\n\n    tinymce.EditorManager.init(this.options).then((editor) => {\n      this.editor = editor[0];\n    });\n  }\n\n  prepareOptions(options: Record<string, any>, version = '6') {\n    const defaults: Partial<EditorOptions> = {};\n\n    if (options.images_upload_url) {\n      defaults.paste_data_images = true;\n      defaults.remove_script_host = false;\n      defaults.relative_urls = false;\n\n      if (Number(version) >= 6) {\n        defaults.images_upload_handler = (blobInfo, progress) =>\n          this.imageUploadHandler(blobInfo, progress);\n      } else {\n        options.plugins.push('paste');\n\n        // @ts-ignore\n        defaults.images_upload_handler = (blobInfo, success, failure, progress) =>\n          this.imageUploadHandler(blobInfo, progress)\n            .then((url) => {\n              success(url);\n              return url;\n            })\n            .catch((e) => {\n              failure(e.message, { remove: true });\n              throw e;\n            });\n      }\n    }\n\n    // defaults.file_picker_callback = (...args) => this.filePickerCallback(...args);\n\n    defaults.plugins = defaults.plugins || [];\n\n    defaults.setup = (editor) => {\n      editor.on('change', () => {\n        this.tinymce.triggerSave();\n      });\n    };\n\n    options = mergeDeep({}, defaults, options);\n\n    if (options.plugins.indexOf('unicorndragdrop') === -1) {\n      options.plugins.push('unicorndragdrop');\n    }\n\n    return options;\n  }\n\n  insert(text: string) {\n    this.editor?.insertContent(text);\n  }\n\n  getValue(): string {\n    return this.editor?.getContent() ?? '';\n  }\n\n  setValue(text: string): void {\n    this.editor?.setContent(text);\n  }\n\n  // filePickerCallback(callback, value, meta) {\n  //   const input = document.createElement('input');\n  //   input.setAttribute('type', 'file');\n  //   input.style.display = 'none';\n  //\n  //   if (meta.filetype === 'image') {\n  //     input.setAttribute('accept', `image/\\*`);\n  //   }\n  //\n  //   document.body.appendChild(input);\n  //\n  //   input.onchange = function () {\n  //     const file = this.files[0];\n  //\n  //     const reader = new FileReader();\n  //     reader.onload = function () {\n  //       const id = 'blobid' + (new Date()).getTime();\n  //       const blobCache =  tinymce.activeEditor.editorUpload.blobCache;\n  //       const base64 = reader.result.split(',')[1];\n  //       const blobInfo = blobCache.create(id, file, base64);\n  //       blobCache.add(blobInfo);\n  //\n  //       /* call the callback and populate the Title field with the file name */\n  //       callback(blobInfo.blobUri(), { title: file.name, text: file.name });\n  //     };\n  //     reader.readAsDataURL(file);\n  //     input.remove();\n  //   };\n  //\n  //   input.click();\n  // }\n\n  async imageUploadHandler(blobInfo: UploadHandlerParams[0], progress: UploadHandlerParams[1]) {\n    const element = this.element;\n\n    element.dispatchEvent(new CustomEvent('upload-start'));\n\n    const formData = new FormData();\n    formData.append('file', blobInfo.blob(), blobInfo.filename());\n\n    const stack = useStack(this.options.unicorn.stack_name);\n    stack.push(true);\n\n    const { post, isAxiosError } = await useHttpClient();\n\n    try {\n      let res = await post(\n        this.options.images_upload_url,\n        formData,\n        {\n          withCredentials: false,\n          onUploadProgress: (e) => {\n            progress(e.loaded / e.total! * 100);\n          }\n        }\n      );\n      element.dispatchEvent(new CustomEvent('upload-success'));\n\n      return res.data.data.url;\n    } catch (err) {\n      if (isAxiosError(err)) {\n        const message = err?.response?.data?.message || err.message;\n        console.error(err?.response?.data?.message || err.message, err);\n        element.dispatchEvent(new CustomEvent('upload-error', { detail: err }));\n\n        return Promise.reject({ message, remove: true });\n      }\n\n      throw err;\n    } finally {\n      element.dispatchEvent(new CustomEvent('upload-complete'));\n      stack.pop();\n    }\n  }\n}\n\nfunction registerDragPlugin(tinymce: TinyMCE) {\n  tinymce.PluginManager.add('unicorndragdrop', function (editor) {\n    // Reset the drop area border\n    tinymce.DOM.bind(document, 'dragleave', function (e) {\n      e.stopPropagation();\n      e.preventDefault();\n\n      if (tinymce.activeEditor) {\n        tinymce.activeEditor.contentAreaContainer.style.transition = 'all .3s';\n        tinymce.activeEditor.contentAreaContainer.style.borderWidth = '';\n      }\n\n      return false;\n    });\n\n    if (typeof FormData !== 'undefined') {\n\n      // Fix for Chrome\n      editor.on('dragenter', e => {\n        e.stopPropagation();\n        return false;\n      });\n\n      // Notify user when file is over the drop area\n      editor.on('dragover', e => {\n        e.preventDefault();\n\n        if (tinymce.activeEditor) {\n          tinymce.activeEditor.contentAreaContainer.style.transition = 'all .3s';\n          tinymce.activeEditor.contentAreaContainer.style.border = '3px dashed rgba(0, 0, 0, .35)';\n        }\n\n        return false;\n      });\n\n      editor.on('drop', e => {\n        editor.contentAreaContainer.style.borderWidth = '';\n        editor.contentAreaContainer.style.borderWidth = '';\n      });\n    }\n  });\n\n  return Promise.resolve();\n}\n\nexport interface TinymceModule {\n  get: typeof get;\n  destroy: typeof destroy;\n  addHook: typeof addHook;\n  clearHooks: typeof clearHooks;\n  TinymceController: typeof TinymceController;\n}\n\ndeclare global {\n  var tinymce: TinyMCE;\n}\n"],"names":["tinymce"],"mappings":"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"}