{"version":3,"file":"field-multi-uploader.js","sources":["../../src/module/field-multi-uploader.ts"],"sourcesContent":["import { Modal } from 'bootstrap';\nimport type { Options } from 'sortablejs';\nimport {\n  type ComponentPublicInstance,\n  computed,\n  createApp,\n  defineComponent,\n  getCurrentInstance,\n  nextTick,\n  onMounted,\n  PropType,\n  ref,\n  useTemplateRef\n} from 'vue';\nimport { VueDraggable } from 'vue-draggable-plus';\nimport {\n  createItem,\n  ItemCard,\n  ItemCardPlaceholder,\n  MultiUploader,\n  MultiUploaderComposableInstance,\n  MultiUploaderOptions,\n  UploaderItem\n} from 'vue-multi-uploader';\nimport css from 'vue-multi-uploader/src/vue-multi-uploader.scss?inline';\nimport { useStack } from '../composable';\nimport { data } from '../data';\nimport { forceArray, injectCssToDocument } from '../service';\nimport { mergeDeep } from '../utilities';\n\ninjectCssToDocument(css);\n\nexport type UniMultiUploaderOptions = {\n  value?: any[];\n  uploadUrl: string;\n  maxFiles?: number;\n  maxConcurrent?: number;\n  thumbSize?: number;\n  accept?: string;\n  readonly: boolean;\n  disabled: boolean;\n  fieldName?: string;\n  fieldFullName?: string;\n  tmplSelector: string;\n  canReplace: false;\n  openFileHandler?: (item: UploaderItem) => void;\n}\n\nconst defaultOptions = {\n  readonly: false,\n  disabled: false,\n  sortable: false,\n  thumbSize: 150,\n  maxConcurrent: 5,\n  canReplace: false,\n  tmplSelector: '#multi-uploader-field-tmpl',\n};\n\nclass MultiUploaderElement extends HTMLElement {\n  static is = 'uni-multi-uploader';\n\n  modalElement!: HTMLDivElement;\n  vm!: ComponentPublicInstance;\n\n  async connectedCallback() {\n    let options: Partial<UniMultiUploaderOptions> = JSON.parse(\n      this.getAttribute('options') || '{}'\n    );\n\n    const resolvedOptions: UniMultiUploaderOptions = mergeDeep({}, defaultOptions, options);\n\n    // Make some default options since PHP will send NULL\n    resolvedOptions.thumbSize ??= 150;\n\n    this.modalElement = this.querySelector<HTMLDivElement>('.modal')!;\n\n    const tmplSelector = resolvedOptions.tmplSelector;\n\n    const app = createApp(\n      createAppInstance(resolvedOptions, document.querySelector(tmplSelector)!.innerHTML, this)\n    );\n\n    this.vm = app.mount(this);\n  }\n}\n\ncustomElements.define(MultiUploaderElement.is, MultiUploaderElement);\n\nfunction createAppInstance(opt: UniMultiUploaderOptions, tmpl: string, el: MultiUploaderElement) {\n  return defineComponent({\n    name: 'MultiUploaderFieldApp',\n    template: tmpl,\n    components: {\n      VueDraggable,\n      MultiUploader,\n      ItemCard,\n      ItemCardPlaceholder,\n    },\n    props: {\n      stackName: String as PropType<string>,\n    },\n    setup(props, { expose }) {\n      const options = ref<UniMultiUploaderOptions>(opt);\n      const current = ref<UploaderItem>();\n      const currentIndex = ref<number>();\n      const loading = ref(false);\n      const dragarea = ref<HTMLDivElement>();\n      const modal = ref<HTMLDivElement>();\n      const app = getCurrentInstance();\n      const uploader = useTemplateRef<typeof MultiUploader>('uploader');\n      const canModify = computed(() => !options.value.disabled && !options.value.readonly);\n      const instance = ref<MultiUploaderComposableInstance>();\n\n      onMounted(() => {\n        instance.value = uploader.value!.instance;\n\n        domEmit('multi-uploader:mounted', { app, uploader });\n      });\n\n      const items = ref<UploaderItem[]>([]);\n\n      for (let item of forceArray(options.value.value)) {\n        if (typeof item === 'string') {\n          item = {\n            url: item\n          };\n        }\n\n        const uploadItem = createItem({\n          url: item.url || '',\n          thumbUrl: item.thumbUrl || item.thumb_url || item.url || '',\n          data: item\n        });\n\n        items.value.push(uploadItem);\n      }\n\n      const uploadUrl = options.value.uploadUrl;\n      const value = items.value;\n      const uploaderOptions = ref<MultiUploaderOptions>({\n        maxFiles: () => options.value.maxFiles,\n        readonly: () => options.value.readonly,\n        disabled: () => options.value.disabled,\n        accept: () => options.value.accept,\n        maxConcurrent: () => options.value.maxConcurrent,\n        prepareXhr(xhr) {\n          xhr.setRequestHeader(\n            'X-CSRF-TOKEN',\n            data('csrf-token')\n          );\n        },\n        onItemUploadSuccess(item, xhr) {\n          const res = JSON.parse(xhr.responseText);\n          item.url = res.data.url;\n          item.thumbUrl = res.data.thumbUrl || res.data.thumb_url || res.data.url;\n          item.data = res.data;\n          item.data.title ??= item.url.split('/').pop()?.split('?').shift() || '';\n        }\n      });\n      const draggableOptions: Options = {\n        draggable: '.c-drag-item',\n        animation: 300,\n        disabled: !canModify.value,\n      };\n\n      function openFile(item: UploaderItem) {\n        if (options.value.openFileHandler) {\n          options.value.openFileHandler(item);\n        } else {\n          window.open(item.download_url || item.url);\n        }\n      }\n\n      async function itemClick(item: UploaderItem, i: number, event: MouseEvent) {\n        current.value = item;\n        currentIndex.value = i;\n\n        domEmit('item-click', { item, i });\n\n        nextTick().then(() => {\n          Modal.getOrCreateInstance(modal.value!).show();\n        });\n        // this.$options.metaModal.modal('show');\n      }\n\n      function metaSave() {\n        current.value = undefined;\n        currentIndex.value = undefined;\n\n        // nextTick().then(() => {\n        // new bootstrap.Modal(modal.value).hide();\n        // });\n        // this.$options.metaModal.modal('hide');\n      }\n\n      function isImage(url: string) {\n        const ext = url.split('.').pop()!.split('?').shift() || '';\n        const allow = ['png', 'jpeg', 'jpg', 'gif', 'bmp', 'webp'];\n\n        return allow.indexOf(ext.toLowerCase()) !== -1;\n      }\n\n      function dragover(e: DragEvent) {\n        if (!options.value.canReplace) {\n          return;\n        }\n\n        dragarea.value!.style.opacity = '0.75';\n      }\n\n      function dragleave(e: DragEvent) {\n        if (!options.value.canReplace) {\n          return;\n        }\n\n        dragarea.value!.style.opacity = '1';\n      }\n\n      function drop(event: DragEvent) {\n        if (!options.value.canReplace) {\n          return;\n        }\n\n        dragarea.value!.style.opacity = '1';\n        const item = current.value;\n        const file = event.dataTransfer?.files[0] || null;\n\n        if (!file) {\n          return;\n        }\n\n        instance.value!.checkFile(file);\n\n        if (instance.value!.isReadonly) {\n          return;\n        }\n\n        item!.file = file;\n\n        loading.value = true;\n\n        try {\n          instance.value!.uploadFile(item!);\n        } finally {\n          loading.value = false;\n        }\n      }\n\n      function uploading() {\n        useStack(props.stackName).push(true);\n\n        domEmit('uploading');\n      }\n\n      function uploaded() {\n        useStack(props.stackName).pop();\n\n        domEmit('uploaded');\n      }\n\n      function onChange(item: UploaderItem) {\n        domEmit('change', item);\n      }\n\n      function domEmit(event: string, detail?: any) {\n        el.dispatchEvent(new CustomEvent(event, { detail }));\n      }\n\n      const foo = ref<string>();\n\n      foo.value = 'Bar';\n\n      const icons = ref<Record<string, string>>({\n        default: 'fas fa-file',\n        pdf: 'fas fa-file-pdf text-danger',\n        xls: 'fas fa-file-excel text-success',\n        xlsx: 'fas fa-file-excel text-success',\n        doc: 'fas fa-file-word text-primary',\n        docx: 'fas fa-file-word text-primary',\n        ppt: 'fas fa-file-powerpoint text-warning',\n        pptx: 'fas fa-file-powerpoint text-warning',\n        zip: 'fas fa-file-archive text-dark',\n        '7z': 'fas fa-file-archive text-dark',\n        rar: 'fas fa-file-archive text-dark',\n        mp4: 'fas fa-file-video text-dark',\n        avi: 'fas fa-file-video text-dark',\n        flv: 'fas fa-file-video text-dark',\n        mov: 'fas fa-file-video text-dark',\n        ogg: 'fas fa-file-video text-dark',\n        webm: 'fas fa-file-video text-dark',\n        mpg: 'fas fa-file-video text-dark',\n        mp3: 'fas fa-file-audio text-dark',\n        acc: 'fas fa-file-audio text-dark',\n        wav: 'fas fa-file-audio text-dark',\n      });\n\n      function setIcons(newIcons: Record<string, string>, merge = true) {\n        if (merge) {\n          icons.value = { ...icons.value, ...newIcons };\n          return;\n        }\n\n        icons.value = newIcons;\n      }\n\n      expose({\n        uploader,\n        instance,\n        value,\n        canModify,\n        openFile,\n        itemClick,\n        isImage,\n        setIcons,\n      });\n\n      function fileIcon(item: UploaderItem) {\n        let path = item.file ? item.file.name : item.url;\n\n        // strip query\n        path = String(path).split('?')[0];\n\n        // Get extension\n        const ext = path.split('.').pop() || '';\n\n        const def = 'default' in icons ? icons.default : 'fas fa-file';\n\n        return icons[String(ext || 'default').toLowerCase() as keyof typeof icons] || def;\n      }\n\n      return {\n        uploader,\n        uploadUrl,\n        value,\n        uploaderOptions,\n        draggableOptions,\n        modal,\n        dragarea,\n        options,\n        current,\n        currentIndex,\n        loading,\n        instance,\n        canModify,\n\n        openFile,\n        itemClick,\n        metaSave,\n        isImage,\n        dragover,\n        dragleave,\n        drop,\n        uploading,\n        uploaded,\n        onChange,\n        domEmit,\n        fileIcon,\n      };\n    }\n  });\n}\n"],"names":[],"mappings":"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"}