{"version":3,"file":"field-repeatable.js","sources":["../../src/module/field-repeatable.ts"],"sourcesContent":["import { cloneDeep } from 'lodash-es';\nimport { initAlpineComponent, prepareAlpineDefer, uid, useCssImport } from '../service';\nimport { mergeDeep } from '../utilities';\n\nexport interface RepeatableOptions {\n  id?: string;\n  fieldName?: string;\n  sortable?: boolean;\n  hasKey?: boolean;\n  singleArray?: boolean;\n  ensureFirstRow?: boolean;\n  max?: number | null;\n}\n\nconst defaultOptions: RepeatableOptions = {\n  id: '',\n  fieldName: '',\n  sortable: false,\n  hasKey: false,\n  singleArray: false,\n  ensureFirstRow: false,\n  max: null,\n};\n\nfunction prepareItem(item: any) {\n  if (item.uid == null) {\n    item.uid = uid();\n  }\n  return item;\n}\n\ntype RepeatableParams = {\n  items: Record<string, any>[];\n  defaultValues: any;\n  attrs: Record<string, any>;\n};\n\nasync function init() {\n  await prepareAlpineDefer(async (Alpine) => {\n    useCssImport('@vue-animate');\n\n    Alpine.data('RepeatableField', ({ items, defaultValues, attrs }: RepeatableParams, options: RepeatableOptions) => ({\n      items,\n      defaultValues,\n      attrs,\n      options: mergeDeep<RepeatableOptions>(defaultOptions, options),\n      init() {\n        // this.items = this.items.filter((item) => item !== '__EMPTY_ARRAY__');\n\n        if (this.options.sortable) {\n          // @see https://github.com/alpinejs/alpine/discussions/1635\n          import('sortablejs').then(({ default: Sortable }) => {\n            Sortable.create(this.$refs.tbody, {\n              handle: '.h-handle',\n              animation: 300,\n              onEnd: (event: any) => {\n                // V3 helper to unwrap the proxy\n                const items = Alpine.raw(this.items);\n\n                // splice mutates the original object, which\n                // you want to avoid. In this case it works because we\n                // created a temporary object that we can control\n                // That way we know there are no side effects\n                const droppedAtItem = items.splice(event.oldIndex, 1)[0];\n                items.splice(event.newIndex, 0, droppedAtItem);\n                //\n                // // Alpine will update when you modify the state,\n                // // so we need to set it back to our new state\n                this.items = items;\n\n                // HACK update prevKeys to new sort order\n                let keys = [];\n                for (let item of items) {\n                  keys.push(item.uid);\n                }\n\n                // HACK update index of dataStack\n                // @ts-ignore\n                this.$refs.steps_template._x_prevKeys = keys;\n                // @ts-ignore\n                const elements = this.$refs.steps_template\n                  .parentElement\n                  .querySelectorAll('tr');\n\n                [].slice.call(elements).forEach((ele, i) => {\n                  // @ts-ignore\n                  if (ele?._x_dataStack[0]?.i != null) {\n                    // @ts-ignore\n                    ele._x_dataStack[0].i = i;\n                  }\n                });\n              }\n            });\n          });\n        }\n\n        this.items.forEach(prepareItem);\n\n        if (this.options.ensureFirstRow) {\n          this.ensureFirstRow();\n        }\n      },\n\n      addItem(i: number) {\n        const item = prepareItem(this.getEmptyItem());\n\n        this.items.splice(i + 1, 0, item);\n      },\n\n      delItem(i: number) {\n        const el = this.getItemElementByUID(this.items[i].uid);\n        let hasAnimate = false;\n\n        el?.addEventListener('animationstart', () => {\n          hasAnimate = true;\n        }, { once: true });\n\n        el?.classList.add('animate__fadeOut');\n\n        setTimeout(() => {\n          if (!hasAnimate) {\n            this._removeItem(i);\n          }\n        }, 100);\n\n        el?.addEventListener('animationend', () => {\n          this._removeItem(i);\n        }, { once: true });\n      },\n\n      _removeItem(i: number) {\n        this.items.splice(i, 1);\n\n        if (this.options.ensureFirstRow) {\n          this.ensureFirstRow();\n        }\n      },\n\n      ensureFirstRow() {\n        if (this.items.length === 0) {\n          this.items.push(prepareItem(this.getEmptyItem()));\n        }\n      },\n\n      getItemElementByUID(uid: string) {\n        return this.$root.querySelector(`[data-item=\"${uid}\"]`);\n      },\n\n      getId(i: number, item: any, field: string) {\n        return `${this.id}-${item.uid}-${field}`;\n      },\n\n      getName(i: number, item: any, field: string) {\n        if (this.options.singleArray) {\n          if (this.options.hasKey) {\n            if (field === 'key') {\n              return '';\n            }\n\n            return `${this.fieldName}[${item.key}]`;\n          }\n\n          return `${this.fieldName}[]`;\n        }\n\n        return `${this.fieldName}[${i}][${field}]`;\n      },\n\n      getEmptyItem() {\n        return cloneDeep(this.defaultValues);\n      },\n\n      get canAdd() {\n        if (!this.options.max) {\n          return true;\n        }\n\n        return this.options.max > this.items.length;\n      },\n\n      get canModify() {\n        return this.attrs.disabled == null && this.attrs.readonly == null;\n      },\n\n      get fieldName() {\n        return this.options.fieldName;\n      },\n\n      get id() {\n        return this.options.id;\n      }\n    }));\n  });\n\n  await initAlpineComponent('data-repeatable');\n}\n\nexport const ready = init();\n\nexport interface RepeatableModule {\n  ready: typeof ready;\n}\n"],"names":["items","uid"],"mappings":"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"}