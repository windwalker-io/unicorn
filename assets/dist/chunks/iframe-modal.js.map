{"version":3,"file":"iframe-modal.js","sources":["../../src/module/iframe-modal.ts"],"sourcesContent":["import { Modal } from 'bootstrap';\r\nimport { useUniDirective } from '../composable';\r\nimport { mergeDeep } from '../utilities';\r\n\r\ninterface IFrameModalOptions {\r\n  id?: string;\r\n  size?: string;\r\n  resize?: boolean;\r\n  height?: string;\r\n}\r\n\r\nexport class IFrameModalElement extends HTMLElement {\r\n  static is = 'uni-iframe-modal';\r\n\r\n  options!: IFrameModalOptions;\r\n  modalElement!: HTMLDivElement;\r\n  modal!: Modal;\r\n  iframe!: HTMLIFrameElement;\r\n\r\n  template() {\r\n    return `\r\n<div class=\"modal fade c-unicorn-iframe-modal\" id=\"${this.getModalId()}\"\r\n    data-iframe-modal>\r\n    <div class=\"modal-dialog ${this.options?.size || 'modal-xl'}\">\r\n        <div class=\"modal-content\">\r\n            <div class=\"modal-body\">\r\n                <iframe class=\"c-unicorn-iframe-modal__iframe\" width=\"100%\" src=\"\" frameborder=\"0\"></iframe>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>`;\r\n  }\r\n\r\n  get selector() {\r\n    return this.getAttribute('selector') || '[data-iframe-modal]';\r\n  }\r\n\r\n  async getBootstrapModal() {\r\n    const { Modal } = await import('bootstrap');\r\n\r\n    return this.modal ??= Modal.getOrCreateInstance(this.modalElement);\r\n  }\r\n\r\n  connectedCallback() {\r\n    this.options = JSON.parse(this.getAttribute('options') || '{}');\r\n\r\n    if (!this.innerHTML.trim()) {\r\n      this.innerHTML = this.template();\r\n    }\r\n\r\n    this.modalElement = this.querySelector<HTMLDivElement>(this.selector)!;\r\n    this.iframe = this.modalElement.querySelector<HTMLIFrameElement>('iframe')!;\r\n\r\n    // @ts-ignore\r\n    this.iframe.modalLink = () => {\r\n      return this;\r\n    };\r\n\r\n    this.bindEvents();\r\n    this.getBootstrapModal();\r\n  }\r\n\r\n  bindEvents() {\r\n    this.modalElement.addEventListener('hidden.bs.modal', () => {\r\n      this.iframe.src = '';\r\n    });\r\n  }\r\n\r\n  async open(href: string, options: IFrameModalOptions = {}) {\r\n    options = mergeDeep(\r\n      {\r\n        height: undefined,\r\n        resize: false,\r\n        size: 'modal-lg',\r\n      },\r\n      this.options,\r\n      options\r\n    );\r\n\r\n    if (options.resize) {\r\n      const onload = () => {\r\n        this.resize(this.iframe);\r\n\r\n        this.iframe.removeEventListener('load', onload);\r\n      };\r\n\r\n      this.iframe.addEventListener('load', onload);\r\n    } else {\r\n      this.iframe.style.height = options.height || '500px';\r\n    }\r\n\r\n    if (options.size != null) {\r\n      const dialog = this.modalElement.querySelector<HTMLDivElement>('.modal-dialog')!;\r\n      dialog.classList.remove('modal-lg', 'modal-xl', 'modal-sm', 'modal-xs');\r\n      dialog.classList.add(options.size);\r\n    }\r\n\r\n    this.iframe.src = href;\r\n    const modal = await this.getBootstrapModal();\r\n    modal.show();\r\n  }\r\n\r\n  async close() {\r\n    this.iframe.src = '';\r\n    const modal = await this.getBootstrapModal();\r\n    modal.hide();\r\n  }\r\n\r\n  resize(iframe: HTMLIFrameElement) {\r\n    setTimeout(() => {\r\n      if (!iframe.contentWindow) {\r\n        return;\r\n      }\r\n\r\n      let height = iframe.contentWindow.document.documentElement.scrollHeight;\r\n\r\n      height += 30;\r\n\r\n      if (height < 500) {\r\n        height = 500;\r\n      }\r\n\r\n      iframe.style.height = height + 'px';\r\n    }, 30);\r\n  }\r\n\r\n  getModalId() {\r\n    return this.options?.id || this.id + '__modal';\r\n  }\r\n}\r\n\r\ncustomElements.define(IFrameModalElement.is, IFrameModalElement);\r\n\r\nexport const ready = useUniDirective('modal-link', {\r\n  mounted(el, binding) {\r\n    let options: IFrameModalOptions = {};\r\n\r\n    options.height = el.dataset.height;\r\n    options.resize = el.dataset.resize === '1' || el.dataset.resize === 'true';\r\n    options.size = el.dataset.size;\r\n\r\n    const target = binding.value;\r\n\r\n    el.style.pointerEvents = '';\r\n\r\n    el.addEventListener('click', (e) => {\r\n      e.preventDefault();\r\n      e.stopPropagation();\r\n      const im = document.querySelector(target);\r\n      \r\n      if (!im) {\r\n        return;\r\n      }\r\n      \r\n      if ('src' in el) {\r\n        im.open(el.src, options);\r\n      } else if ('href' in el) {\r\n        im.open(el.href, options);\r\n      }\r\n    });\r\n  }\r\n});\r\n\r\nexport interface IframeModalModule {\r\n  IFrameModalElement: typeof IFrameModalElement;\r\n  ready: typeof ready;\r\n}\r\n"],"names":["Modal"],"mappings":"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"}