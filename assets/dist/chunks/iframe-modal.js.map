{"version":3,"file":"iframe-modal.js","sources":["../../src/module/iframe-modal.ts"],"sourcesContent":["import { Modal } from 'bootstrap';\nimport { useUniDirective } from '../composable';\nimport { mergeDeep } from '../utilities';\n\ninterface IFrameModalOptions {\n  id?: string;\n  size?: string;\n  resize?: boolean;\n  height?: string;\n}\n\nexport class IFrameModalElement extends HTMLElement {\n  static is = 'uni-iframe-modal';\n\n  options!: IFrameModalOptions;\n  modalElement!: HTMLDivElement;\n  modal!: Modal;\n  iframe!: HTMLIFrameElement;\n\n  template() {\n    return `\n<div class=\"modal fade c-unicorn-iframe-modal\" id=\"${this.getModalId()}\"\n    data-iframe-modal>\n    <div class=\"modal-dialog ${this.options?.size || 'modal-xl'}\">\n        <div class=\"modal-content\">\n            <div class=\"modal-body\">\n                <iframe class=\"c-unicorn-iframe-modal__iframe\" width=\"100%\" src=\"\" frameborder=\"0\"></iframe>\n            </div>\n        </div>\n    </div>\n</div>`;\n  }\n\n  get selector() {\n    return this.getAttribute('selector') || '[data-iframe-modal]';\n  }\n\n  async getBootstrapModal() {\n    const { Modal } = await import('bootstrap');\n\n    return this.modal ??= Modal.getOrCreateInstance(this.modalElement);\n  }\n\n  connectedCallback() {\n    this.options = JSON.parse(this.getAttribute('options') || '{}');\n\n    if (!this.innerHTML.trim()) {\n      this.innerHTML = this.template();\n    }\n\n    this.modalElement = this.querySelector<HTMLDivElement>(this.selector)!;\n    this.iframe = this.modalElement.querySelector<HTMLIFrameElement>('iframe')!;\n\n    // @ts-ignore\n    this.iframe.modalLink = () => {\n      return this;\n    };\n\n    this.bindEvents();\n    this.getBootstrapModal();\n  }\n\n  bindEvents() {\n    this.modalElement.addEventListener('hidden.bs.modal', () => {\n      this.iframe.src = '';\n    });\n  }\n\n  async open(href: string, options: IFrameModalOptions = {}) {\n    options = mergeDeep(\n      {\n        height: undefined,\n        resize: false,\n        size: 'modal-lg',\n      },\n      this.options,\n      options\n    );\n\n    if (options.resize) {\n      const onload = () => {\n        this.resize(this.iframe);\n\n        this.iframe.removeEventListener('load', onload);\n      };\n\n      this.iframe.addEventListener('load', onload);\n    } else {\n      this.iframe.style.height = options.height || '500px';\n    }\n\n    if (options.size != null) {\n      const dialog = this.modalElement.querySelector<HTMLDivElement>('.modal-dialog')!;\n      dialog.classList.remove('modal-lg', 'modal-xl', 'modal-sm', 'modal-xs');\n      dialog.classList.add(options.size);\n    }\n\n    this.iframe.src = href;\n    const modal = await this.getBootstrapModal();\n    modal.show();\n  }\n\n  async close() {\n    this.iframe.src = '';\n    const modal = await this.getBootstrapModal();\n    modal.hide();\n  }\n\n  resize(iframe: HTMLIFrameElement) {\n    setTimeout(() => {\n      if (!iframe.contentWindow) {\n        return;\n      }\n\n      let height = iframe.contentWindow.document.documentElement.scrollHeight;\n\n      height += 30;\n\n      if (height < 500) {\n        height = 500;\n      }\n\n      iframe.style.height = height + 'px';\n    }, 30);\n  }\n\n  getModalId() {\n    return this.options?.id || this.id + '__modal';\n  }\n}\n\nasync function init() {\n  customElements.define(IFrameModalElement.is, IFrameModalElement);\n\n  return useUniDirective('modal-link', {\n    mounted(el, binding) {\n      let options: IFrameModalOptions = {};\n\n      options.height = el.dataset.height;\n      options.resize = el.dataset.resize === '1' || el.dataset.resize === 'true';\n      options.size = el.dataset.size;\n\n      const target = binding.value;\n\n      el.style.pointerEvents = '';\n\n      el.addEventListener('click', (e) => {\n        e.preventDefault();\n        e.stopPropagation();\n        const im = document.querySelector(target);\n\n        if (!im) {\n          return;\n        }\n\n        if ('src' in el) {\n          im.open(el.src, options);\n        } else if ('href' in el) {\n          im.open(el.href, options);\n        }\n      });\n    }\n  });\n}\nexport const ready = init();\n\nexport interface IFrameModalModule {\n  IFrameModalElement: typeof IFrameModalElement;\n  ready: typeof ready;\n}\n"],"names":["Modal"],"mappings":"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"}