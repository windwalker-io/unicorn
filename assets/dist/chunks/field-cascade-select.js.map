{"version":3,"file":"field-cascade-select.js","sources":["../../../../../../node_modules/@rubenbimmel/alpine-class-component/dist/alpineComponent.js","../../../../../../node_modules/@rubenbimmel/alpine-class-component/dist/decorators/component.js","../../src/module/field-cascade-select.ts"],"sourcesContent":["\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nclass AlpineComponent {\r\n}\r\nexports.default = AlpineComponent;\r\n","\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nfunction Component(component) {\r\n    return function (...args) {\r\n        let instance = new component(...args);\r\n        const proto = component.prototype;\r\n        let data = {};\r\n        Object.getOwnPropertyNames(proto).forEach(function (key) {\r\n            if (key === 'constructor') {\r\n                return;\r\n            }\r\n            const descriptor = Object.getOwnPropertyDescriptor(proto, key);\r\n            if (descriptor.value !== void 0) {\r\n                if (typeof descriptor.value === 'function') {\r\n                    data[key] = descriptor.value;\r\n                }\r\n            }\r\n            else if (descriptor.get || descriptor.set) {\r\n                Object.defineProperty(data, key, { get: descriptor.get, set: descriptor.set });\r\n            }\r\n        });\r\n        return Object.assign(data, instance);\r\n    };\r\n}\r\nexports.default = Component;\r\n","import AlpineComponent from '@rubenbimmel/alpine-class-component/dist/alpineComponent';\nimport Component from '@rubenbimmel/alpine-class-component/dist/decorators/component';\nimport { useHttpClient } from '../composable';\nimport { initAlpineComponent, module, prepareAlpineDefer, uid } from '../service';\nimport { mergeDeep } from '../utilities';\n\ninterface CascadeSelectOptions {\n  id: string;\n  selected: string;\n  path: string[];\n  ignoreSelf: boolean | null;\n  placeholder: string;\n  placeholders: string[];\n  ajaxUrl: string;\n  ajaxValueField: string;\n  source: string[];\n  labels: string[];\n  labelWidth: string;\n  fieldWidth: string;\n  readonly: boolean;\n  disabled: boolean;\n  valueField: string;\n  textField: string;\n  horizontal: boolean | null;\n  horizontalColWidth: string | null;\n  defaultValue: string;\n  onSelectInit: Function,\n  onChange: Function,\n  onValueInit: Function,\n}\n\nconst defaultOptions = {\n  id: '',\n  selected: '',\n  path: [],\n  ignoreSelf: null,\n  placeholder: '- Select -',\n  placeholders: [],\n  ajaxUrl: '',\n  ajaxValueField: 'value',\n  source: [],\n  labels: [],\n  labelWidth: 'col-md-3',\n  fieldWidth: 'col',\n  readonly: false,\n  disabled: false,\n  valueField: 'id',\n  textField: 'title',\n  horizontal: null,\n  horizontalColWidth: null,\n  defaultValue: '',\n  onSelectInit: () => {\n  },\n  onChange: () => {\n  },\n  onValueInit: () => {\n  },\n};\n\n@Component\nclass FieldCascadeSelect extends AlpineComponent {\n  options: CascadeSelectOptions;\n  el?: HTMLElement;\n  canModify: boolean = false;\n  lists: any[] = [];\n  ajaxUrl: string = '';\n  values: Array<string | null> = [];\n\n  constructor(options: Partial<CascadeSelectOptions> = {}) {\n    super();\n\n    this.options = mergeDeep({}, defaultOptions, options);\n\n    this.options.id = this.options.id || 'cascade-select-' + uid();\n  }\n\n  init() {\n    this.canModify = !this.options.readonly && !this.options.disabled;\n    this.ajaxUrl = this.options.ajaxUrl;\n    this.values = this.options.path.slice().map(String);\n\n    let values: Array<string | null> = this.options.path.slice();\n\n    if (values.length === 0) {\n      values = [null];\n    } else {\n      values.unshift(null);\n    }\n\n    let promise = Promise.resolve();\n    let lastValue: string | null = null;\n\n    values.forEach((v, i) => {\n      promise = promise.then(() => {\n        return this.loadItems(v, i).then((list) => {\n          if (list.length > 0) {\n            this.lists.push(list);\n          }\n        });\n      });\n\n      lastValue = v;\n    });\n\n    this.el = this.$el;\n\n    module(this.$el, 'cascade.select', () => this);\n\n    this.valueInit(this.$el, lastValue, values);\n  }\n\n  getLabel(i: number) {\n    return this.options.labels[i] || `Level ${i + 1}`;\n  }\n\n  getId(i: number) {\n    return `${this.options.id}__level-${i}`;\n  }\n\n  getListValue(i: number) {\n    return this.values[i] || '';\n  }\n\n  isSelected(i: number, item: any) {\n    return String(this.getListValue(i)) === String(item[this.options.valueField]);\n  }\n\n  getFinalValue() {\n    const values = this.values.slice();\n\n    if (values.length === 0) {\n      return this.options.defaultValue;\n    }\n\n    const v = values\n      .filter(v => v != null)\n      .filter(v => v !== '')\n      .pop();\n\n    if (v == undefined) {\n      return this.options.defaultValue;\n    }\n\n    return v;\n  }\n\n  getLevel() {\n    return this.values.length;\n  }\n\n  async onChange(i: number, event: Event) {\n    const el = event.target as HTMLSelectElement;\n\n    this.values[i] = el.value;\n\n    this.options.onChange(event);\n\n    event.stopPropagation();\n\n    const changeEvent = new CustomEvent('change', {\n      detail: {\n        el,\n        component: this,\n        value: el.value,\n        path: this.values\n      }\n    });\n\n    this.el?.dispatchEvent(changeEvent);\n\n    if (el.value === '') {\n      // Clear child\n      this.lists.splice(i + 1);\n      this.values.splice(i + 1);\n      return;\n    }\n\n    // Get child list\n    let list = await this.loadItems(el.value, i);\n    this.lists.splice(i + 1);\n    this.values.splice(i + 1);\n    if (list.length > 0) {\n      this.lists.push(list);\n    }\n  }\n\n  async loadItems(parentId: string | null, i: number) {\n    // Ajax\n    if (this.ajaxUrl) {\n      const http = await useHttpClient();\n\n      let res = await http.get(\n        this.ajaxUrl,\n        {\n          params: {\n            [this.options.ajaxValueField]: parentId,\n            self: this.options.ignoreSelf || null\n          }\n        }\n      );\n      return await res.data.data;\n    }\n\n    // Source\n    if (parentId) {\n      return Promise.resolve(\n        this.handleSourceItems(\n          this.findFromList(this.lists[i - 1] || [], parentId)?.children || []\n        )\n      );\n    }\n\n    return Promise.resolve(this.handleSourceItems(this.options.source));\n  }\n\n  valueInit($select: HTMLElement, value: string | null, path: Array<string | null>) {\n    const event = new CustomEvent('value.init', {\n      detail: {\n        el: $select,\n        component: this,\n        value,\n        path\n      }\n    });\n\n    this.options.onSelectInit(event);\n\n    this.$el.dispatchEvent(event);\n  }\n\n  selectInit($select: HTMLElement) {\n    const event = new CustomEvent('select.init', {\n      detail: {\n        el: $select,\n        component: this,\n      }\n    });\n\n    this.options.onSelectInit(event);\n\n    this.$el.dispatchEvent(event);\n  }\n\n  handleSourceItems(items: any[]) {\n    return items.map(item => {\n      return {\n        [this.options.valueField]: item.value[this.options.valueField],\n        [this.options.textField]: item.value[this.options.textField],\n        children: item.children\n      };\n    })\n      .filter(item => {\n        if (this.options.ignoreSelf) {\n          return item[this.options.valueField] != this.options.ignoreSelf;\n        }\n\n        return item;\n      });\n  }\n\n  findFromList(items: any[], value: string) {\n    const found = items.filter(item => item[this.options.valueField] == value);\n\n    return found.shift();\n  }\n\n  getPlaceholder(i: number) {\n    if (this.options.placeholders[i]) {\n      return this.options.placeholders[i];\n    }\n\n    return this.options.placeholder;\n  }\n}\n\ndeclare global {\n  var S: any;\n}\n\nasync function init() {\n  await prepareAlpineDefer(() => {\n    Alpine.data('CascadeSelect', (options: CascadeSelectOptions) => new FieldCascadeSelect(options));\n  });\n\n  await initAlpineComponent('data-cascade-select');\n}\n\nexport const ready = init();\n\nexport interface CascadeSelectModule {\n  ready: typeof ready;\n}\n"],"names":["AlpineComponent","Component","component","v"],"mappings":"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","x_google_ignoreList":[0,1]}