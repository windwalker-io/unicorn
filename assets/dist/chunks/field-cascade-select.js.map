{"version":3,"file":"field-cascade-select.js","sources":["../../../../../../node_modules/@rubenbimmel/alpine-class-component/dist/alpineComponent.js","../../../../../../node_modules/@rubenbimmel/alpine-class-component/dist/decorators/component.js","../../src/module/field-cascade-select.ts"],"sourcesContent":["\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nclass AlpineComponent {\r\n}\r\nexports.default = AlpineComponent;\r\n","\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nfunction Component(component) {\r\n    return function (...args) {\r\n        let instance = new component(...args);\r\n        const proto = component.prototype;\r\n        let data = {};\r\n        Object.getOwnPropertyNames(proto).forEach(function (key) {\r\n            if (key === 'constructor') {\r\n                return;\r\n            }\r\n            const descriptor = Object.getOwnPropertyDescriptor(proto, key);\r\n            if (descriptor.value !== void 0) {\r\n                if (typeof descriptor.value === 'function') {\r\n                    data[key] = descriptor.value;\r\n                }\r\n            }\r\n            else if (descriptor.get || descriptor.set) {\r\n                Object.defineProperty(data, key, { get: descriptor.get, set: descriptor.set });\r\n            }\r\n        });\r\n        return Object.assign(data, instance);\r\n    };\r\n}\r\nexports.default = Component;\r\n","import AlpineComponent from '@rubenbimmel/alpine-class-component/dist/alpineComponent';\r\nimport Component from '@rubenbimmel/alpine-class-component/dist/decorators/component';\r\nimport { useHttpClient } from '../composable';\r\nimport { initAlpineComponent, module, prepareAlpineDefer, uid } from '../service';\r\nimport { mergeDeep } from '../utilities';\r\n\r\ninterface CascadeSelectOptions {\r\n  id: string;\r\n  selected: string;\r\n  path: string[];\r\n  ignoreSelf: boolean | null;\r\n  placeholder: string;\r\n  placeholders: string[];\r\n  ajaxUrl: string;\r\n  ajaxValueField: string;\r\n  source: string[];\r\n  labels: string[];\r\n  labelWidth: string;\r\n  fieldWidth: string;\r\n  readonly: boolean;\r\n  disabled: boolean;\r\n  valueField: string;\r\n  textField: string;\r\n  horizontal: boolean | null;\r\n  horizontalColWidth: string | null;\r\n  defaultValue: string;\r\n  onSelectInit: Function,\r\n  onChange: Function,\r\n  onValueInit: Function,\r\n}\r\n\r\nconst defaultOptions = {\r\n  id: '',\r\n  selected: '',\r\n  path: [],\r\n  ignoreSelf: null,\r\n  placeholder: '- Select -',\r\n  placeholders: [],\r\n  ajaxUrl: '',\r\n  ajaxValueField: 'value',\r\n  source: [],\r\n  labels: [],\r\n  labelWidth: 'col-md-3',\r\n  fieldWidth: 'col',\r\n  readonly: false,\r\n  disabled: false,\r\n  valueField: 'id',\r\n  textField: 'title',\r\n  horizontal: null,\r\n  horizontalColWidth: null,\r\n  defaultValue: '',\r\n  onSelectInit: () => {\r\n  },\r\n  onChange: () => {\r\n  },\r\n  onValueInit: () => {\r\n  },\r\n};\r\n\r\n@Component\r\nclass FieldCascadeSelect extends AlpineComponent {\r\n  options: CascadeSelectOptions;\r\n  el?: HTMLElement;\r\n  canModify: boolean = false;\r\n  lists: any[] = [];\r\n  ajaxUrl: string = '';\r\n  values: Array<string | null> = [];\r\n\r\n  constructor(options: Partial<CascadeSelectOptions> = {}) {\r\n    super();\r\n\r\n    this.options = mergeDeep({}, defaultOptions, options);\r\n\r\n    this.options.id = this.options.id || 'cascade-select-' + uid();\r\n  }\r\n\r\n  init() {\r\n    this.canModify = !this.options.readonly && !this.options.disabled;\r\n    this.ajaxUrl = this.options.ajaxUrl;\r\n    this.values = this.options.path.slice().map(String);\r\n\r\n    let values: Array<string | null> = this.options.path.slice();\r\n\r\n    if (values.length === 0) {\r\n      values = [null];\r\n    } else {\r\n      values.unshift(null);\r\n    }\r\n\r\n    let promise = Promise.resolve();\r\n    let lastValue: string | null = null;\r\n\r\n    values.forEach((v, i) => {\r\n      promise = promise.then(() => {\r\n        return this.loadItems(v, i).then((list) => {\r\n          if (list.length > 0) {\r\n            this.lists.push(list);\r\n          }\r\n        });\r\n      });\r\n\r\n      lastValue = v;\r\n    });\r\n\r\n    this.el = this.$el;\r\n\r\n    module(this.$el, 'cascade.select', () => this);\r\n\r\n    this.valueInit(this.$el, lastValue, values);\r\n  }\r\n\r\n  getLabel(i: number) {\r\n    return this.options.labels[i] || `Level ${i + 1}`;\r\n  }\r\n\r\n  getId(i: number) {\r\n    return `${this.options.id}__level-${i}`;\r\n  }\r\n\r\n  getListValue(i: number) {\r\n    return this.values[i] || '';\r\n  }\r\n\r\n  isSelected(i: number, item: any) {\r\n    return String(this.getListValue(i)) === String(item[this.options.valueField]);\r\n  }\r\n\r\n  getFinalValue() {\r\n    const values = this.values.slice();\r\n\r\n    if (values.length === 0) {\r\n      return this.options.defaultValue;\r\n    }\r\n\r\n    const v = values\r\n      .filter(v => v != null)\r\n      .filter(v => v !== '')\r\n      .pop();\r\n\r\n    if (v == undefined) {\r\n      return this.options.defaultValue;\r\n    }\r\n\r\n    return v;\r\n  }\r\n\r\n  getLevel() {\r\n    return this.values.length;\r\n  }\r\n\r\n  async onChange(i: number, event: Event) {\r\n    const el = event.target as HTMLSelectElement;\r\n\r\n    this.values[i] = el.value;\r\n\r\n    this.options.onChange(event);\r\n\r\n    event.stopPropagation();\r\n\r\n    const changeEvent = new CustomEvent('change', {\r\n      detail: {\r\n        el,\r\n        component: this,\r\n        value: el.value,\r\n        path: this.values\r\n      }\r\n    });\r\n\r\n    this.el?.dispatchEvent(changeEvent);\r\n\r\n    if (el.value === '') {\r\n      // Clear child\r\n      this.lists.splice(i + 1);\r\n      this.values.splice(i + 1);\r\n      return;\r\n    }\r\n\r\n    // Get child list\r\n    let list = await this.loadItems(el.value, i);\r\n    this.lists.splice(i + 1);\r\n    this.values.splice(i + 1);\r\n    if (list.length > 0) {\r\n      this.lists.push(list);\r\n    }\r\n  }\r\n\r\n  async loadItems(parentId: string | null, i: number) {\r\n    // Ajax\r\n    if (this.ajaxUrl) {\r\n      const http = await useHttpClient();\r\n\r\n      let res = await http.get(\r\n        this.ajaxUrl,\r\n        {\r\n          params: {\r\n            [this.options.ajaxValueField]: parentId,\r\n            self: this.options.ignoreSelf || null\r\n          }\r\n        }\r\n      );\r\n      return await res.data.data;\r\n    }\r\n\r\n    // Source\r\n    if (parentId) {\r\n      return Promise.resolve(\r\n        this.handleSourceItems(\r\n          this.findFromList(this.lists[i - 1] || [], parentId)?.children || []\r\n        )\r\n      );\r\n    }\r\n\r\n    return Promise.resolve(this.handleSourceItems(this.options.source));\r\n  }\r\n\r\n  valueInit($select: HTMLElement, value: string | null, path: Array<string | null>) {\r\n    const event = new CustomEvent('value.init', {\r\n      detail: {\r\n        el: $select,\r\n        component: this,\r\n        value,\r\n        path\r\n      }\r\n    });\r\n\r\n    this.options.onSelectInit(event);\r\n\r\n    this.$el.dispatchEvent(event);\r\n  }\r\n\r\n  selectInit($select: HTMLElement) {\r\n    const event = new CustomEvent('select.init', {\r\n      detail: {\r\n        el: $select,\r\n        component: this,\r\n      }\r\n    });\r\n\r\n    this.options.onSelectInit(event);\r\n\r\n    this.$el.dispatchEvent(event);\r\n  }\r\n\r\n  handleSourceItems(items: any[]) {\r\n    return items.map(item => {\r\n      return {\r\n        [this.options.valueField]: item.value[this.options.valueField],\r\n        [this.options.textField]: item.value[this.options.textField],\r\n        children: item.children\r\n      };\r\n    })\r\n      .filter(item => {\r\n        if (this.options.ignoreSelf) {\r\n          return item[this.options.valueField] != this.options.ignoreSelf;\r\n        }\r\n\r\n        return item;\r\n      });\r\n  }\r\n\r\n  findFromList(items: any[], value: string) {\r\n    const found = items.filter(item => item[this.options.valueField] == value);\r\n\r\n    return found.shift();\r\n  }\r\n\r\n  getPlaceholder(i: number) {\r\n    if (this.options.placeholders[i]) {\r\n      return this.options.placeholders[i];\r\n    }\r\n\r\n    return this.options.placeholder;\r\n  }\r\n}\r\n\r\ndeclare global {\r\n  var S: any;\r\n}\r\n\r\nasync function init() {\r\n  await prepareAlpineDefer(() => {\r\n    Alpine.data('CascadeSelect', (options: CascadeSelectOptions) => new FieldCascadeSelect(options));\r\n  });\r\n\r\n  await initAlpineComponent('data-cascade-select');\r\n}\r\n\r\nexport const ready = init();\r\n\r\nexport interface CascadeSelectModule {\r\n  ready: typeof ready;\r\n}\r\n"],"names":["AlpineComponent","Component","component","v"],"mappings":"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","x_google_ignoreList":[0,1]}