{"version":3,"file":"field-file-drag.js","sources":["../../src/module/field-file-drag.ts"],"sourcesContent":["import css from '../../scss/field/file-drag.scss?inline';\nimport { useUniDirective } from '../composable';\nimport { __, html, injectCssToDocument, simpleAlert, uid, watchAttributes } from '../service';\nimport { mergeDeep } from '../utilities';\n\nexport interface FileDragOptions {\n  maxFiles: number | undefined;\n  maxSize: number | undefined;\n  placeholder: string;\n  height: number;\n}\n\nconst defaultOptions: FileDragOptions = {\n  maxFiles: undefined,\n  maxSize: undefined,\n  placeholder: '',\n  height: 125,\n}\n\nexport class FileDragElement extends HTMLElement {\n  static is = 'uni-file-drag';\n\n  element!: HTMLInputElement;\n  overlayLabel!: HTMLLabelElement;\n  button!: HTMLButtonElement;\n  options!: FileDragOptions;\n\n  get inputSelector() {\n    return this.getAttribute('selector') || 'input[type=file]';\n  }\n\n  get multiple() {\n    return this.element.multiple;\n  }\n\n  connectedCallback(): void {\n    this.element = this.querySelector(this.inputSelector)!;\n\n    this.prepareElements();\n\n    const options = JSON.parse(this.getAttribute('options') || '{}') || {};\n\n    const observer = watchAttributes(this.element);\n    observer.watch('readonly', (el) => {\n      el.disabled = el.readOnly;\n    });\n\n    if (this.element.readOnly) {\n      this.element.disabled = true;\n    }\n\n    this.options = mergeDeep({}, defaultOptions, options);\n\n    this.bindEvent();\n\n    this.style.visibility = '';\n\n    this.style.height = (this.options.height || 100) + 'px';\n  }\n\n  bindEvent() {\n    this.element.addEventListener('dragover', () => {\n      this.element.classList.add('hover');\n    });\n\n    this.element.addEventListener('dragleave', () => {\n      this.element.classList.remove('hover');\n    });\n\n    this.element.addEventListener('drop', () => {\n      this.element.classList.remove('hover');\n    });\n\n    this.onChange();\n\n    this.element.addEventListener('change', (e) => {\n      this.onChange(e);\n    });\n    this.element.addEventListener('input', (e) => {\n      this.onChange(e);\n    });\n  }\n\n  prepareElements() {\n    if (this.children.length === 0) {\n      this.createElementsLayout();\n    }\n\n    this.overlayLabel = this.querySelector<HTMLLabelElement>('[data-overlay-label]')!;\n\n    let button = this.overlayLabel.querySelector('button');\n\n    // B/C for new file drag style\n    if (!button) {\n      button = document.createElement('button');\n      button.type = 'button';\n      button.setAttribute('class', 'c-file-drag-input__button btn btn-success btn-sm px-2 py-1');\n      button.innerText = __('unicorn.field.file.drag.button.text');\n      this.overlayLabel.appendChild(button);\n    }\n\n    this.button = button;\n  }\n\n  createElementsLayout() {\n    this.id ||= 'c-file-drag-' + uid();\n    const name = this.getAttribute('name') || 'file';\n    const inputId = this.id + '__input';\n    const btnText = __('unicorn.field.file.drag.button.text');\n\n    const input = html(`<input id=\"${inputId}\" type=\"file\" name=\"${name}\" />`);\n    const label = html(`<label class=\"px-3 c-file-drag-input__label\"\n        data-overlay-label\n        for=\"${inputId}\">\n        <span class=\"label-text d-block\">\n            <span class=\"fa fa-upload\"></span>\n        </span>\n        <button type=\"button\" class=\"c-file-drag-input__button btn btn-success btn-sm px-2 py-1\">\n            ${btnText}\n        </button>\n    </label>`);\n\n    this.element = input as HTMLInputElement;\n    this.overlayLabel = label as HTMLLabelElement;\n\n    this.appendChild(input);\n    this.appendChild(label);\n  }\n\n  onChange(evt?: Event) {\n    const files = this.element.files || [];\n    const limit = this.options.maxFiles;\n    const maxSize = this.options.maxSize;\n    let placeholder = this.options.placeholder;\n\n    const accepted = (this.element.getAttribute('accept') || this.element.getAttribute('data-accepted') || '')\n      .split(',')\n      .map(v => v.trim())\n      .filter(v => v.length > 0)\n      .map(v => {\n        if (v.indexOf('/') === -1 && v[0] === '.') {\n          return v.substring(1);\n        }\n\n        return v;\n      });\n\n    let text: string;\n\n    if (!placeholder) {\n      if (this.multiple) {\n        placeholder = __('unicorn.field.file.drag.placeholder.multiple');\n      } else {\n        placeholder = __('unicorn.field.file.drag.placeholder.single');\n      }\n    }\n\n    // Files limit\n    if (limit && files.length > limit) {\n      this.alert(__('unicorn.field.file.drag.message.max.files', limit), '', 'warning');\n      evt?.preventDefault();\n      return;\n    }\n\n    // Files size\n    let fileSize = 0;\n    Array.prototype.forEach.call(files, file => {\n      this.checkFileType(accepted, file);\n\n      fileSize += file.size;\n    });\n\n    if (maxSize && (fileSize / 1024 / 1024) > maxSize) {\n      this.alert(\n        __(\n          'unicorn.field.file.drag.message.max.size',\n          maxSize < 1 ? (maxSize * 1024) + 'KB' : maxSize + 'MB'\n        ),\n        '',\n        'warning'\n      );\n      evt?.preventDefault();\n      return;\n    }\n\n    if (files.length > 1) {\n      text = `<span class=\"fa fa-files fa-copy\"></span> ${__('unicorn.field.file.drag.selected', files.length)}`;\n    } else if (files.length === 1) {\n      text = `<span class=\"fa fa-file\"></span> ${files[0].name}`;\n    } else {\n      text = `<span class=\"fa fa-upload\"></span> ${placeholder}`;\n    }\n\n    //replace the \"Choose a file\" label\n    this.overlayLabel.querySelector<HTMLSpanElement>('span')!.innerHTML = text;\n  }\n\n  checkFileType(accepted: string[], file: File) {\n    const fileExt = file.name.split('.').pop() || '';\n\n    if (accepted.length) {\n      let allow = false;\n\n      accepted.forEach((type) => {\n        if (allow) {\n          return;\n        }\n\n        if (type.indexOf('/') !== -1) {\n          if (this.compareMimeType(type, file.type)) {\n            allow = true;\n          }\n        } else {\n          if (type.toLowerCase() === fileExt.toLowerCase()) {\n            allow = true;\n          }\n        }\n      });\n\n      if (!allow) {\n        this.alert(\n          __('unicorn.field.file.drag.message.unaccepted.files'),\n          __('unicorn.field.file.drag.message.unaccepted.files.desc', accepted.join(', ')),\n          'warning'\n        );\n        throw new Error('Not accepted file ext');\n      }\n    }\n  }\n\n  compareMimeType(accepted: string, mime: string) {\n    const accepted2 = accepted.split('/');\n    const mime2 = mime.split('/');\n\n    if (accepted2[1] === '*') {\n      return accepted2[0] === mime2[0];\n    }\n\n    return accepted === mime;\n  }\n\n  async alert(title: string, text: string = '', type: string = 'info') {\n    await simpleAlert(title, text, type);\n  }\n}\n\nasync function init() {\n  injectCssToDocument(document, css);\n  customElements.define(FileDragElement.is, FileDragElement);\n\n return useUniDirective('file-drag-field', {\n   mounted(el) {\n     const input = el.querySelector<HTMLInputElement>('input[type=file]')!;\n     const placeholderInput = el.querySelector<HTMLInputElement>('[data-role=placeholder]')!;\n\n     const preview = el.querySelector('.c-file-drag-preview');\n\n     if (preview) {\n       const previewLink = preview.querySelector<HTMLAnchorElement>('.c-file-drag-preview__link')!;\n       const delButton = preview.querySelector<HTMLAnchorElement>('.c-file-drag-preview__delete')!;\n       // let linkTitle = previewLink.textContent;\n       let inputValue = placeholderInput.value;\n       let required = input.required;\n\n       if (placeholderInput.value) {\n         input.required = false;\n       }\n\n       delButton.addEventListener('click', () => {\n         if (delButton.classList.contains('active')) {\n           // Restore\n           previewLink.style.textDecoration = '';\n           previewLink.style.setProperty('color', '');\n           placeholderInput.value = inputValue;\n           delButton.classList.remove('active');\n           input.required = false;\n         } else {\n           // Delete\n           previewLink.style.textDecoration = 'line-through';\n           previewLink.style.color = 'var(--fd-delete-color, var(--bs-danger))';\n           placeholderInput.value = '';\n           delButton.classList.add('active');\n           input.required = required;\n         }\n       });\n     }\n   }\n });\n}\n\nexport const ready = init();\n\nexport interface FileDragModule {\n  FileDragElement: typeof FileDragElement;\n}\n"],"names":[],"mappings":";;AAYA,MAAM,iBAAkC;AAAA,EACtC,UAAU;AAAA,EACV,SAAS;AAAA,EACT,aAAa;AAAA,EACb,QAAQ;AACV;AAEO,MAAM,wBAAwB,YAAY;AAAA,EAC/C,OAAO,KAAK;AAAA,EAEZ;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EAEA,IAAI,gBAAgB;AAClB,WAAO,KAAK,aAAa,UAAU,KAAK;AAAA,EAC1C;AAAA,EAEA,IAAI,WAAW;AACb,WAAO,KAAK,QAAQ;AAAA,EACtB;AAAA,EAEA,oBAA0B;AACxB,SAAK,UAAU,KAAK,cAAc,KAAK,aAAa;AAEpD,SAAK,gBAAA;AAEL,UAAM,UAAU,KAAK,MAAM,KAAK,aAAa,SAAS,KAAK,IAAI,KAAK,CAAA;AAEpE,UAAM,WAAW,gBAAgB,KAAK,OAAO;AAC7C,aAAS,MAAM,YAAY,CAAC,OAAO;AACjC,SAAG,WAAW,GAAG;AAAA,IACnB,CAAC;AAED,QAAI,KAAK,QAAQ,UAAU;AACzB,WAAK,QAAQ,WAAW;AAAA,IAC1B;AAEA,SAAK,UAAU,UAAU,CAAA,GAAI,gBAAgB,OAAO;AAEpD,SAAK,UAAA;AAEL,SAAK,MAAM,aAAa;AAExB,SAAK,MAAM,UAAU,KAAK,QAAQ,UAAU,OAAO;AAAA,EACrD;AAAA,EAEA,YAAY;AACV,SAAK,QAAQ,iBAAiB,YAAY,MAAM;AAC9C,WAAK,QAAQ,UAAU,IAAI,OAAO;AAAA,IACpC,CAAC;AAED,SAAK,QAAQ,iBAAiB,aAAa,MAAM;AAC/C,WAAK,QAAQ,UAAU,OAAO,OAAO;AAAA,IACvC,CAAC;AAED,SAAK,QAAQ,iBAAiB,QAAQ,MAAM;AAC1C,WAAK,QAAQ,UAAU,OAAO,OAAO;AAAA,IACvC,CAAC;AAED,SAAK,SAAA;AAEL,SAAK,QAAQ,iBAAiB,UAAU,CAAC,MAAM;AAC7C,WAAK,SAAS,CAAC;AAAA,IACjB,CAAC;AACD,SAAK,QAAQ,iBAAiB,SAAS,CAAC,MAAM;AAC5C,WAAK,SAAS,CAAC;AAAA,IACjB,CAAC;AAAA,EACH;AAAA,EAEA,kBAAkB;AAChB,QAAI,KAAK,SAAS,WAAW,GAAG;AAC9B,WAAK,qBAAA;AAAA,IACP;AAEA,SAAK,eAAe,KAAK,cAAgC,sBAAsB;AAE/E,QAAI,SAAS,KAAK,aAAa,cAAc,QAAQ;AAGrD,QAAI,CAAC,QAAQ;AACX,eAAS,SAAS,cAAc,QAAQ;AACxC,aAAO,OAAO;AACd,aAAO,aAAa,SAAS,4DAA4D;AACzF,aAAO,YAAY,GAAG,qCAAqC;AAC3D,WAAK,aAAa,YAAY,MAAM;AAAA,IACtC;AAEA,SAAK,SAAS;AAAA,EAChB;AAAA,EAEA,uBAAuB;AACrB,SAAK,OAAO,iBAAiB,IAAA;AAC7B,UAAM,OAAO,KAAK,aAAa,MAAM,KAAK;AAC1C,UAAM,UAAU,KAAK,KAAK;AAC1B,UAAM,UAAU,GAAG,qCAAqC;AAExD,UAAM,QAAQ,KAAK,cAAc,OAAO,uBAAuB,IAAI,MAAM;AACzE,UAAM,QAAQ,KAAK;AAAA;AAAA,eAER,OAAO;AAAA;AAAA;AAAA;AAAA;AAAA,cAKR,OAAO;AAAA;AAAA,aAER;AAET,SAAK,UAAU;AACf,SAAK,eAAe;AAEpB,SAAK,YAAY,KAAK;AACtB,SAAK,YAAY,KAAK;AAAA,EACxB;AAAA,EAEA,SAAS,KAAa;AACpB,UAAM,QAAQ,KAAK,QAAQ,SAAS,CAAA;AACpC,UAAM,QAAQ,KAAK,QAAQ;AAC3B,UAAM,UAAU,KAAK,QAAQ;AAC7B,QAAI,cAAc,KAAK,QAAQ;AAE/B,UAAM,YAAY,KAAK,QAAQ,aAAa,QAAQ,KAAK,KAAK,QAAQ,aAAa,eAAe,KAAK,IACpG,MAAM,GAAG,EACT,IAAI,CAAA,MAAK,EAAE,KAAA,CAAM,EACjB,OAAO,CAAA,MAAK,EAAE,SAAS,CAAC,EACxB,IAAI,CAAA,MAAK;AACR,UAAI,EAAE,QAAQ,GAAG,MAAM,MAAM,EAAE,CAAC,MAAM,KAAK;AACzC,eAAO,EAAE,UAAU,CAAC;AAAA,MACtB;AAEA,aAAO;AAAA,IACT,CAAC;AAEH,QAAI;AAEJ,QAAI,CAAC,aAAa;AAChB,UAAI,KAAK,UAAU;AACjB,sBAAc,GAAG,8CAA8C;AAAA,MACjE,OAAO;AACL,sBAAc,GAAG,4CAA4C;AAAA,MAC/D;AAAA,IACF;AAGA,QAAI,SAAS,MAAM,SAAS,OAAO;AACjC,WAAK,MAAM,GAAG,6CAA6C,KAAK,GAAG,IAAI,SAAS;AAChF,WAAK,eAAA;AACL;AAAA,IACF;AAGA,QAAI,WAAW;AACf,UAAM,UAAU,QAAQ,KAAK,OAAO,CAAA,SAAQ;AAC1C,WAAK,cAAc,UAAU,IAAI;AAEjC,kBAAY,KAAK;AAAA,IACnB,CAAC;AAED,QAAI,WAAY,WAAW,OAAO,OAAQ,SAAS;AACjD,WAAK;AAAA,QACH;AAAA,UACE;AAAA,UACA,UAAU,IAAK,UAAU,OAAQ,OAAO,UAAU;AAAA,QAAA;AAAA,QAEpD;AAAA,QACA;AAAA,MAAA;AAEF,WAAK,eAAA;AACL;AAAA,IACF;AAEA,QAAI,MAAM,SAAS,GAAG;AACpB,aAAO,6CAA6C,GAAG,oCAAoC,MAAM,MAAM,CAAC;AAAA,IAC1G,WAAW,MAAM,WAAW,GAAG;AAC7B,aAAO,oCAAoC,MAAM,CAAC,EAAE,IAAI;AAAA,IAC1D,OAAO;AACL,aAAO,sCAAsC,WAAW;AAAA,IAC1D;AAGA,SAAK,aAAa,cAA+B,MAAM,EAAG,YAAY;AAAA,EACxE;AAAA,EAEA,cAAc,UAAoB,MAAY;AAC5C,UAAM,UAAU,KAAK,KAAK,MAAM,GAAG,EAAE,SAAS;AAE9C,QAAI,SAAS,QAAQ;AACnB,UAAI,QAAQ;AAEZ,eAAS,QAAQ,CAAC,SAAS;AACzB,YAAI,OAAO;AACT;AAAA,QACF;AAEA,YAAI,KAAK,QAAQ,GAAG,MAAM,IAAI;AAC5B,cAAI,KAAK,gBAAgB,MAAM,KAAK,IAAI,GAAG;AACzC,oBAAQ;AAAA,UACV;AAAA,QACF,OAAO;AACL,cAAI,KAAK,YAAA,MAAkB,QAAQ,eAAe;AAChD,oBAAQ;AAAA,UACV;AAAA,QACF;AAAA,MACF,CAAC;AAED,UAAI,CAAC,OAAO;AACV,aAAK;AAAA,UACH,GAAG,kDAAkD;AAAA,UACrD,GAAG,yDAAyD,SAAS,KAAK,IAAI,CAAC;AAAA,UAC/E;AAAA,QAAA;AAEF,cAAM,IAAI,MAAM,uBAAuB;AAAA,MACzC;AAAA,IACF;AAAA,EACF;AAAA,EAEA,gBAAgB,UAAkB,MAAc;AAC9C,UAAM,YAAY,SAAS,MAAM,GAAG;AACpC,UAAM,QAAQ,KAAK,MAAM,GAAG;AAE5B,QAAI,UAAU,CAAC,MAAM,KAAK;AACxB,aAAO,UAAU,CAAC,MAAM,MAAM,CAAC;AAAA,IACjC;AAEA,WAAO,aAAa;AAAA,EACtB;AAAA,EAEA,MAAM,MAAM,OAAe,OAAe,IAAI,OAAe,QAAQ;AACnE,UAAM,YAAY,OAAO,MAAM,IAAI;AAAA,EACrC;AACF;AAEA,eAAe,OAAO;AACpB,sBAAoB,UAAU,GAAG;AACjC,iBAAe,OAAO,gBAAgB,IAAI,eAAe;AAE1D,SAAO,gBAAgB,mBAAmB;AAAA,IACxC,QAAQ,IAAI;AACV,YAAM,QAAQ,GAAG,cAAgC,kBAAkB;AACnE,YAAM,mBAAmB,GAAG,cAAgC,yBAAyB;AAErF,YAAM,UAAU,GAAG,cAAc,sBAAsB;AAEvD,UAAI,SAAS;AACX,cAAM,cAAc,QAAQ,cAAiC,4BAA4B;AACzF,cAAM,YAAY,QAAQ,cAAiC,8BAA8B;AAEzF,YAAI,aAAa,iBAAiB;AAClC,YAAI,WAAW,MAAM;AAErB,YAAI,iBAAiB,OAAO;AAC1B,gBAAM,WAAW;AAAA,QACnB;AAEA,kBAAU,iBAAiB,SAAS,MAAM;AACxC,cAAI,UAAU,UAAU,SAAS,QAAQ,GAAG;AAE1C,wBAAY,MAAM,iBAAiB;AACnC,wBAAY,MAAM,YAAY,SAAS,EAAE;AACzC,6BAAiB,QAAQ;AACzB,sBAAU,UAAU,OAAO,QAAQ;AACnC,kBAAM,WAAW;AAAA,UACnB,OAAO;AAEL,wBAAY,MAAM,iBAAiB;AACnC,wBAAY,MAAM,QAAQ;AAC1B,6BAAiB,QAAQ;AACzB,sBAAU,UAAU,IAAI,QAAQ;AAChC,kBAAM,WAAW;AAAA,UACnB;AAAA,QACF,CAAC;AAAA,MACH;AAAA,IACF;AAAA,EAAA,CACD;AACF;AAEO,MAAM,QAAQ,qBAAA;"}