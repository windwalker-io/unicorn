{"version":3,"file":"s3-uploader.js","sources":["../../src/module/s3-uploader.ts"],"sourcesContent":["import { useHttpClient } from '../composable';\r\nimport { data } from '../data';\r\nimport { EventAwareInterface, EventHandler, EventMixin } from '../events';\r\nimport type { UnicornHttpClient } from './http-client';\r\nimport { mergeDeep } from '../utilities';\r\nimport { AxiosProgressEvent, AxiosResponse } from 'axios';\r\nimport { Mixin } from 'ts-mixer';\r\n\r\nconst instances: Record<string, S3Uploader> = {};\r\nexport function get(name: string, options?: Partial<S3UploaderGlobalOptions>): S3Uploader;\r\nexport function get(\r\n  name: string,\r\n  options: Partial<S3UploaderGlobalOptions> = {}\r\n): S3Uploader | void {\r\n  return instances[name] ??= create(name, options);\r\n}\r\n\r\nexport function create(name: string, options: Partial<S3UploaderGlobalOptions> = {}): S3Uploader {\r\n  return new S3Uploader(name, options);\r\n}\r\n\r\nexport function destroy(name: string) {\r\n  delete instances[name];\r\n}\r\n\r\nconst defaultOptions: S3UploaderGlobalOptions = {\r\n  endpoint: '',\r\n  subfolder: '',\r\n  viewerHost: '',\r\n  starts_with: [],\r\n  formInputs: {\r\n    acl: '',\r\n    bucket: '',\r\n    key: '',\r\n    Policy: '',\r\n    'X-Amz-Algorithm': '',\r\n    'X-Amz-Credential': '',\r\n    'X-Amz-Date': '',\r\n    'X-Amz-Signature': '',\r\n  }\r\n};\r\n\r\nexport class S3Uploader extends Mixin(EventMixin) implements EventAwareInterface {\r\n  options: S3UploaderGlobalOptions;\r\n  http?: UnicornHttpClient;\r\n\r\n  constructor(protected name: string, options: Partial<S3UploaderGlobalOptions> = {}) {\r\n    super();\r\n\r\n    const awsOptions = data('@s3.uploader.' + name) || {};\r\n\r\n    this.options = mergeDeep<S3UploaderGlobalOptions>({}, defaultOptions, awsOptions, options);\r\n  }\r\n\r\n  async getHttpClient() {\r\n    return this.http ??= await useHttpClient();\r\n  }\r\n\r\n  /**\r\n   * Do upload.\r\n   */\r\n  async upload(\r\n    file: string | File | Blob,\r\n    path: string,\r\n    options: Partial<S3UploaderRequestOptions> = {}\r\n  ): Promise<S3UploaderResponse> {\r\n    const httpClient = await this.getHttpClient();\r\n\r\n    const fileData = new FormData();\r\n    const inputs = mergeDeep({}, this.options.formInputs, options.formInputs || {});\r\n\r\n    if (typeof file === 'string') {\r\n      file = new Blob([file], { type: options['Content-Type'] || 'text/plain' });\r\n    }\r\n\r\n    if (file instanceof Blob && path.endsWith('.{ext}')) {\r\n      throw new Error('If using Blob or file data string, you must provide a valid file extension in the path.');\r\n    }\r\n\r\n    if ((file instanceof Blob) || (file as any) instanceof File) {\r\n      options['Content-Type'] = options['Content-Type'] || file.type;\r\n    }\r\n\r\n    if (options['filename']) {\r\n      const filename = this.replaceExt(options['filename'], file);\r\n      options['Content-Disposition'] = 'attachment; filename*=UTF-8\\'\\'' + encodeURIComponent(filename);\r\n    }\r\n\r\n    path = this.replaceExt(path, file);\r\n\r\n    options['key'] = trimSlashes(this.options.subfolder || '') + '/'\r\n      + trimSlashes(path);\r\n    options['key'] = trimSlashes(options['key']);\r\n    options['Content-Type'] = options['Content-Type'] || undefined;\r\n    options['Content-Disposition'] = options['Content-Disposition'] || undefined;\r\n\r\n    // Prepare pre-signed data\r\n    for (let key in inputs) {\r\n      fileData.set(key, inputs[key]);\r\n    }\r\n\r\n    // Prepare custom data\r\n    for (let key of Object.keys(this.options.starts_with)) {\r\n      if (options[key]) {\r\n        fileData.set(key, options[key]);\r\n      }\r\n    }\r\n\r\n    fileData.append('file', file);\r\n\r\n    this.trigger('start', fileData);\r\n\r\n    try {\r\n      let res = await httpClient.post(\r\n        this.options.endpoint || '',\r\n        fileData,\r\n        {\r\n          onUploadProgress: (e) => {\r\n            if (options.onUploadProgress) {\r\n              options.onUploadProgress(e);\r\n            }\r\n\r\n            this.trigger('upload-progress', e);\r\n\r\n            if (e.total != null) {\r\n              this.trigger('progress', e.loaded / e.total, e);\r\n            }\r\n          }\r\n        }\r\n      ) as S3UploaderResponse;\r\n\r\n      const url = this.options.viewerHost + '/'\r\n        + trimSlashes(path);\r\n\r\n      this.trigger('success', url, res);\r\n\r\n      res.url = url;\r\n\r\n      return res;\r\n    } finally {\r\n      this.trigger('end');\r\n    }\r\n  }\r\n\r\n  replaceExt(path: string, file: File | Blob): string {\r\n    if (file instanceof File) {\r\n      const fileExt = file.name.split('.').pop();\r\n\r\n      if (path.endsWith('.{ext}')) {\r\n        return path.replace(/\\.{ext}$/, fileExt ? '.' + fileExt : '');\r\n      }\r\n    }\r\n\r\n    return path;\r\n  }\r\n\r\n  on(event: 'start', handler: StartEventHandler): this;\r\n  on(event: 'success', handler: SuccessEventHandler): this;\r\n  on(event: 'end', handler: EndEventHandler): this;\r\n  on(event: 'upload-progress', handler: UploadProgressEventHandler): this;\r\n  on(event: 'progress', handler: ProgressEventHandler): this;\r\n  on(event: string | string[], handler: EventHandler): this {\r\n    return super.on(event, handler);\r\n  }\r\n\r\n  onStart(handler: StartEventHandler): this {\r\n    return this.on('start', handler);\r\n  }\r\n\r\n  onSuccess(handler: SuccessEventHandler): this {\r\n    return this.on('success', handler);\r\n  }\r\n\r\n  onEnd(handler: EndEventHandler): this {\r\n    return this.on('end', handler);\r\n  }\r\n\r\n  onProgress(handler: UploadProgressEventHandler): this {\r\n    return this.on('upload-progress', handler);\r\n  }\r\n\r\n  onProgressWithTotal(handler: ProgressEventHandler): this {\r\n    return this.on('progress', handler);\r\n  }\r\n}\r\n\r\ntype EndEventHandler = () => void;\r\ntype SuccessEventHandler = (url: string, res: S3UploaderResponse) => void;\r\ntype StartEventHandler = (fileData: FormData) => void;\r\ntype UploadProgressEventHandler = (e: AxiosProgressEvent) => void;\r\ntype ProgressEventHandler = (total: number, e: AxiosProgressEvent) => void;\r\n\r\nfunction trimSlashes(str: string) {\r\n  return str.replace(/^\\/+|\\/+$/g, '');\r\n}\r\n\r\nexport interface S3UploaderResponse extends AxiosResponse {\r\n  url: string;\r\n}\r\n\r\nexport interface S3UploaderGlobalOptions {\r\n  endpoint?: string;\r\n  subfolder?: string;\r\n  viewerHost?: string;\r\n  starts_with: any[];\r\n  formInputs?: {\r\n    acl: string;\r\n    bucket: string;\r\n    key: string;\r\n    Policy: string;\r\n    'X-Amz-Algorithm': string;\r\n    'X-Amz-Credential': string;\r\n    'X-Amz-Date': string;\r\n    'X-Amz-Signature': string;\r\n    [name: string]: any\r\n  },\r\n}\r\n\r\nexport interface S3UploaderRequestOptions {\r\n  formInputs?: { [name: string]: any };\r\n  onUploadProgress?: (e: AxiosProgressEvent) => void;\r\n  'Content-Type'?: string;\r\n  'Content-Disposition'?: string;\r\n  key?: string;\r\n\r\n  [name: string]: any;\r\n}\r\n\r\nexport interface S3UploaderModule {\r\n  get(name: string, options?: Partial<S3UploaderGlobalOptions>): S3Uploader;\r\n  create(name: string, options?: Partial<S3UploaderGlobalOptions>): S3Uploader;\r\n  destroy(name: string): void;\r\n  S3Uploader: typeof S3Uploader;\r\n}\r\n"],"names":[],"mappings":"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"}